<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タイムトラッキングタイマー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        #confirm-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto space-y-8">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-900">Task Timer</h1>
            <p class="text-gray-500 text-sm mt-2">データはURLの末尾にCSV形式で効率的に保存されます</p>
        </header>

        <!-- Timer Section -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 text-center">
            <div id="display" class="mono text-6xl md:text-8xl font-bold text-blue-600 mb-8">
                00:00:00
            </div>
            <div class="flex justify-center gap-4">
                <button id="main-btn" class="px-10 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full transition-all transform active:scale-95 shadow-lg flex items-center gap-2">
                    <span id="btn-icon">▶</span>
                    <span id="btn-text">START</span>
                </button>
            </div>
        </section>

        <!-- Summary Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-blue-50 border border-blue-100 p-6 rounded-xl">
                <h3 class="text-blue-800 text-sm font-semibold uppercase tracking-wider mb-1">合計経過時間</h3>
                <div id="total-time" class="mono text-3xl font-bold text-blue-900">00:00:00</div>
            </div>
            <div class="bg-gray-100 border border-gray-200 p-6 rounded-xl flex flex-col justify-center">
                <h3 class="text-gray-600 text-sm font-semibold uppercase tracking-wider mb-1">記録件数</h3>
                <div id="record-count" class="mono text-3xl font-bold text-gray-800">0</div>
            </div>
        </section>

        <!-- Records Table -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 border-bottom border-gray-200">
                            <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase">開始日時</th>
                            <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase">終了日時</th>
                            <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase text-right">経過時間</th>
                        </tr>
                    </thead>
                    <tbody id="record-list" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div id="empty-state" class="p-12 text-center text-gray-400">
                記録はまだありません
            </div>
        </section>

        <!-- Reset Button -->
        <footer class="flex justify-center pt-4">
            <button id="reset-btn" class="text-red-500 hover:text-red-700 text-sm font-medium transition-colors flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                すべての記録をリセット
            </button>
        </footer>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs w-full mx-4">
            <h3 class="text-lg font-bold mb-2">記録のリセット</h3>
            <p class="text-gray-600 mb-6 text-sm">すべてのタイマー記録を消去します。この操作は取り消せません。</p>
            <div class="flex gap-3">
                <button id="confirm-cancel" class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium">キャンセル</button>
                <button id="confirm-ok" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">リセットする</button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let records = []; // Each element: {start: timestamp, end: timestamp}
        let isRunning = false;
        let startTime = null;
        let timerInterval = null;

        const display = document.getElementById('display');
        const mainBtn = document.getElementById('main-btn');
        const btnIcon = document.getElementById('btn-icon');
        const btnText = document.getElementById('btn-text');
        const recordList = document.getElementById('record-list');
        const totalTimeDisplay = document.getElementById('total-time');
        const recordCountDisplay = document.getElementById('record-count');
        const emptyState = document.getElementById('empty-state');
        const resetBtn = document.getElementById('reset-btn');
        const modal = document.getElementById('confirm-modal');
        const confirmOk = document.getElementById('confirm-ok');
        const confirmCancel = document.getElementById('confirm-cancel');

        window.addEventListener('load', () => {
            loadFromURL();
            renderTable();
        });

        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            const hrs = Math.floor(s / 3600);
            const mins = Math.floor((s % 3600) / 60);
            const secs = s % 60;
            return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function formatDateTime(timestamp) {
            const d = new Date(parseInt(timestamp));
            return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
        }

        function updateDisplay() {
            if (!startTime) return;
            const elapsed = Date.now() - startTime;
            display.textContent = formatTime(elapsed);
        }

        /**
         * Save records to URL hash as CSV string: start,end;start,end;...
         */
        function saveToURL() {
            if (records.length === 0) {
                // Clear hash without adding to history
                history.replaceState(null, null, ' ');
                return;
            }
            const csv = records.map(r => `${r.start},${r.end}`).join(';');
            location.hash = csv;
        }

        /**
         * Load records from URL hash
         */
        function loadFromURL() {
            const hash = location.hash.substring(1);
            if (!hash) return;
            try {
                // Split by semicolon for records, then comma for start/end
                records = hash.split(';').map(pair => {
                    const [start, end] = pair.split(',');
                    return { start: parseInt(start), end: parseInt(end) };
                }).filter(r => !isNaN(r.start) && !isNaN(r.end));
            } catch (e) {
                console.error("Failed to parse records from URL", e);
                records = [];
            }
        }

        function renderTable() {
            recordList.innerHTML = '';
            let totalMs = 0;

            if (records.length === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                [...records].reverse().forEach(record => {
                    const diff = record.end - record.start;
                    totalMs += diff;

                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50 transition-colors";
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-600 mono">${formatDateTime(record.start)}</td>
                        <td class="px-6 py-4 text-sm text-gray-600 mono">${formatDateTime(record.end)}</td>
                        <td class="px-6 py-4 text-sm font-bold text-gray-900 mono text-right">${formatTime(diff)}</td>
                    `;
                    recordList.appendChild(row);
                });
            }

            totalTimeDisplay.textContent = formatTime(totalMs);
            recordCountDisplay.textContent = records.length;
        }

        mainBtn.addEventListener('click', () => {
            if (!isRunning) {
                isRunning = true;
                startTime = Date.now();
                mainBtn.classList.replace('bg-blue-600', 'bg-red-600');
                mainBtn.classList.replace('hover:bg-blue-700', 'hover:bg-red-700');
                btnText.textContent = 'STOP';
                btnIcon.textContent = '■';
                timerInterval = setInterval(updateDisplay, 1000);
            } else {
                isRunning = false;
                const endTime = Date.now();
                clearInterval(timerInterval);
                
                records.push({ start: startTime, end: endTime });
                saveToURL();
                renderTable();
                
                startTime = null;
                display.textContent = '00:00:00';
                mainBtn.classList.replace('bg-red-600', 'bg-blue-600');
                mainBtn.classList.replace('hover:bg-red-700', 'hover:bg-blue-700');
                btnText.textContent = 'START';
                btnIcon.textContent = '▶';
            }
        });

        resetBtn.addEventListener('click', () => {
            modal.style.display = 'flex';
        });

        confirmCancel.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        confirmOk.addEventListener('click', () => {
            records = [];
            saveToURL();
            renderTable();
            modal.style.display = 'none';
            
            if (isRunning) {
                clearInterval(timerInterval);
                isRunning = false;
                startTime = null;
                display.textContent = '00:00:00';
                mainBtn.classList.replace('bg-red-600', 'bg-blue-600');
                btnText.textContent = 'START';
                btnIcon.textContent = '▶';
            }
        });
    </script>
</body>
</html>
